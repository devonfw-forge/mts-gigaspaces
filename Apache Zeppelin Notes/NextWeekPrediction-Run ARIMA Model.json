{"paragraphs":[{"title":"Establish Spark connection","text":"%python\r\nimport pandas as pd\r\nfrom pyspark.conf import SparkConf\r\nfrom pyspark.sql import SparkSession\r\nfrom pmdarima.arima import auto_arima\r\nimport findspark\r\nfindspark.init('C:/Users/dpatesan/Desktop/gigaspaces-insightedge-enterprise-15.5.1/insightedge/spark')\r\nconf = SparkConf() \r\nconf.setAppName(\"InsightEdge Python Example\")\r\nconf.set(\"spark.insightedge.space.name\", \"CG-space\")\r\nconf.set(\"spark.insightedge.space.lookup.group\", \"xap-15.5.1 \")\r\nconf.set(\"spark.insightedge.space.lookup.locator\", \"127.0.0.1:4174\")\r\n\r\nspark = SparkSession.builder.config(conf=conf).getOrCreate()","user":"anonymous","dateUpdated":"2020-12-31T20:01:55+0100","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionSupport":true},"editorMode":"ace/mode/python","title":true,"lineNumbers":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1607275617003_1136835490","id":"20201206-182657_116556461","dateCreated":"2020-12-06T18:26:57+0100","dateStarted":"2021-01-01T23:36:52+0100","dateFinished":"2021-01-01T23:36:52+0100","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:9102"},{"title":"Get Parameters for the next Week from the Grid (to be used for prediction)","text":"%python\r\npredictionForecastDataRaw = spark.read.format(\"org.apache.spark.sql.insightedge\").option(\"collection\",\"com.devonfw.application.mtsj.predictionmanagement.dataaccess.api.PredictionForecastDataEntity\").load()\r\npredictionForecastData = predictionForecastDataRaw[\"temperature\",\"timestamp\",\"holiday\"].toPandas()\r\npredictionForecastData= predictionForecastData.sort_values(by=['timestamp'])\r\n\r\nprediction_exog = predictionForecastData[['temperature', 'holiday']].values","user":"anonymous","dateUpdated":"2021-01-04T02:03:32+0100","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionSupport":true},"editorMode":"ace/mode/python","title":true,"lineNumbers":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1607275745671_1527720084","id":"20201206-182905_1344231735","dateCreated":"2020-12-06T18:29:05+0100","dateStarted":"2021-01-01T23:36:52+0100","dateFinished":"2021-01-01T23:36:54+0100","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:9103"},{"title":"Import the Models","text":"%python\nimport pickle\nmodels = list()\nfor i in range(7):\n    filename = 'model'+str(i)+'.sav'\n    loaded_model = pickle.load(open(filename, 'rb'))\n    models.append(loaded_model)\n","user":"anonymous","dateUpdated":"2020-12-31T20:02:01+0100","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionSupport":true},"editorMode":"ace/mode/python","title":true,"lineNumbers":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1607275764759_-1243737925","id":"20201206-182924_479997920","dateCreated":"2020-12-06T18:29:24+0100","dateStarted":"2021-01-01T23:36:54+0100","dateFinished":"2021-01-01T23:36:54+0100","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:9104"},{"title":"Generating the predictions","text":"%python\nimport uuid\nn = len(models)\nforecast = []\ntimestamp = pd.Series(range(0,n),dtype=pd.Int64Dtype())\nfor i in range(n):    \n    ids =[]\n    df = pd.DataFrame(models[i].predict(7,prediction_exog),columns=[\"forecast\"])\n    for  j in range(n):\n         ids.append(str(uuid.uuid4()))\n    df['id'] = ids\n    df['timestamp'] = timestamp\n    df['dishId'] = i\n    \n    forecast.append(df)\n    ","user":"anonymous","dateUpdated":"2020-12-31T20:04:14+0100","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionSupport":true},"editorMode":"ace/mode/python","title":true,"lineNumbers":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1607275775919_-651232620","id":"20201206-182935_902885121","dateCreated":"2020-12-06T18:29:35+0100","dateStarted":"2021-01-01T23:36:54+0100","dateFinished":"2021-01-01T23:36:54+0100","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:9105"},{"title":"Create a Schema to match the POJO stored in the Space","text":"%python\nfrom pyspark.sql.types import *\n\nschema = StructType([\n  StructField(\"forecast\", DoubleType(), True),\n  StructField(\"id\",StringType(),False),\n  StructField(\"timestamp\", IntegerType(), True),\n  StructField(\"dishId\", StringType(), True)]\n  )\ndf = pd.concat(forecast)\ndf = spark.createDataFrame(df,schema)\n","user":"anonymous","dateUpdated":"2020-12-31T20:04:01+0100","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionSupport":true},"editorMode":"ace/mode/python","title":true,"lineNumbers":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1607275781416_2009062203","id":"20201206-182941_2115735176","dateCreated":"2020-12-06T18:29:41+0100","dateStarted":"2021-01-01T23:36:54+0100","dateFinished":"2021-01-01T23:36:54+0100","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:9106"},{"title":"Store the predictions into the Grid","text":"%python\ndf.write.format(\"org.apache.spark.sql.insightedge\").mode(\"overwrite\").save(\"com.devonfw.application.mtsj.predictionmanagement.dataaccess.api.PredictionDayDataEntity\")","user":"anonymous","dateUpdated":"2020-12-31T20:02:10+0100","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionSupport":true},"editorMode":"ace/mode/python","title":true,"lineNumbers":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"\r[Stage 5:>                                                          (0 + 4) / 4]\r                                                                                \r"}]},"apps":[],"jobName":"paragraph_1607275786736_-454513952","id":"20201206-182946_345926949","dateCreated":"2020-12-06T18:29:46+0100","dateStarted":"2021-01-01T23:36:55+0100","dateFinished":"2021-01-01T23:37:01+0100","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:9107"},{"text":"%python\n","user":"anonymous","dateUpdated":"2020-12-11T07:12:23+0100","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1607667143129_676359095","id":"20201211-071223_324592728","dateCreated":"2020-12-11T07:12:23+0100","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:9108"}],"name":"NextWeekPrediction-Run ARIMA Model","id":"2FU9WRG39","noteParams":{},"noteForms":{},"angularObjects":{"python:shared_process":[],"spark:shared_process":[]},"config":{"isZeppelinNotebookCronEnable":false,"looknfeel":"default","personalizedMode":"false"},"info":{}}